# app-audio-downloader - アーキテクチャ設計書

## 1. システム全体像

```
┌─────────────────────────────────────────────────┐
│                    User                         │
└─────────────────────────────────────────────────┘
         ↓ (CLI Input: URL)
┌─────────────────────────────────────────────────┐
│  download.py (CLI Entrypoint)                   │
│    ├─ Interactive Mode (対話モード)              │
│    └─ Argument Mode (引数モード)                 │
└─────────────────────────────────────────────────┘
         ↓ (Download Request)
┌─────────────────────────────────────────────────┐
│  yt-dlp Engine                                  │
│    ├─ yt-dlp-rajiko Plugin                      │
│    │    ├─ Auth (auth1/auth2)                   │
│    │    ├─ Playlist Extraction (m3u8)           │
│    │    └─ Area/Premium Check                   │
│    └─ Browser Cookies (Edge)                    │
└─────────────────────────────────────────────────┘
         ↓ (Stream Data)
┌─────────────────────────────────────────────────┐
│  External Tools                                 │
│    └─ ffmpeg (Conversion/Muxing)                │
└─────────────────────────────────────────────────┘
         ↓ (Output File)
┌─────────────────────────────────────────────────┐
│  Local Filesystem (*.m4a)                       │
└─────────────────────────────────────────────────┘
```

## 2. モジュール設計

### 2.1 download.py

**役割**: ユーザーインターフェースとダウンロードプロセスの制御

**主要関数**:
```python
def interactive_mode():
    """対話モードのメインループ"""
    # ユーザーからURLを複数行入力として受け取る
    # クッキー使用有無を確認
    # 各URLに対して download_radiko を呼び出し

def download_radiko(url, output_template=None, cookie_file=None, credentials=None):
    """yt-dlpを使用したダウンロード実行"""
    # yt_dlp.YoutubeDL のオプション設定
    # 認証情報（クッキーファイルまたはメール/パスワード）の設定
    # ダウンロード実行とエラーハンドリング

if __name__ == "__main__":
    # 引数の有無でモード切り替え
```

## 3. データフロー

### 3.1 ダウンロードフロー

1.  **入力**: ユーザーがRadikoのURL（`https://radiko.jp/#!/ts/...`）を入力。
2.  **認証**: 
    - 環境変数（`.env`）からの自動読み込み
    - 手動入力
    - クッキーファイル（`cookies.txt`）の利用
    のいずれかを選択・適用。
3.  **初期化**: `yt_dlp.YoutubeDL` インスタンスを生成。
4.  **解析**: `yt-dlp-rajiko` プラグインがURLを解析し、認証トークンを取得。
5.  **取得**: ストリームデータ（m3u8）を取得し、セグメントをダウンロード。
6.  **保存**: `ffmpeg` を介して単一のm4aファイルに結合・保存。

## 4. エラーハンドリング

- **無効なURL**: `yt-dlp` がエラーをスローし、キャッチしてエラーメッセージを表示。次のURLの処理へ移行（対話モード時）。
- **認証エラー**: クッキーが無効、または地域外の場合にエラーを表示。
- **ffmpeg未検出**: 依存関係エラーとしてプロセスが終了する可能性あり（事前確認推奨）。

## 5. 拡張性

### 5.1 対応サイトの追加
- `yt-dlp` ベースのため、Radiko以外のサイト（YouTube, niconico等）もURLを渡すだけで理論上はダウンロード可能（ただし本ツールの主目的はRadiko）。

### 5.2 自動化
- クーロン（cron）やLaunchAgentと組み合わせることで、定期的な自動ダウンロードスクリプトとして利用可能。

## 6. セキュリティ考慮事項

- **クッキー利用**: `cookiesfrombrowser` オプションを使用し、ローカルブラウザの認証情報を一時的に利用します。これらは外部に送信されません。
- **保存先**: カレントディレクトリに保存されます。書き込み権限が必要です。
